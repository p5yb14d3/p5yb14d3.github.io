<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>80s Blue CRT Terminal</title>
    <style>
        body {
            background-color: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            font-family: 'VT323', monospace;
        }
        @font-face {
            font-family: 'VT323';
            src: url('https://fonts.gstatic.com/s/vt323/v17/pxiKyp0ihIEF2isfFJU.woff2') format('woff2');
        }
        #terminal {
            background-color: #000020;
            color: #8989db;
            width: 80%;
            height: 80%;
            padding: 20px;
            font-size: 36px;
            line-height: 1.4;
            overflow-y: scroll;
            scrollbar-width: none;
            -ms-overflow-style: none;
            border: 2px solid #4040ff;
            box-shadow: 0 0 10px #4040ff, 0 0 20px #4040ff inset;
            position: relative;
            animation: textShadowPulse 2s infinite;
        }
        #terminal::-webkit-scrollbar {
            display: none;
        }
        #terminal::before {
            content: " ";
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: 
                linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%),
                linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 4px, 3px 100%;
            z-index: 2;
            pointer-events: none;
        }
        #cursor {
            display: inline-block;
            width: 18px;
            height: 36px;
            background-color: #8989db;
            animation: blink 0.7s infinite;
        }
        @keyframes blink {
            0% { opacity: 0; }
            50% { opacity: 1; }
            100% { opacity: 0; }
        }
        @keyframes textShadowPulse {
            0% { text-shadow: 0 0 4px #4040ff; }
            50% { text-shadow: 0 0 4px #4040ff, 0 0 10px #4040ff; }
            100% { text-shadow: 0 0 4px #4040ff; }
        }
		#hiddenInput {
			position: absolute;
			opacity: 0;
			height: 0;
			width: 0;
		}
		
		#fullscreen-button {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: transparent;
			border: 0;
			cursor: pointer;
			z-index:100;
		}
    </style>
</head>
<body>
    <!--nput type="text" id="hiddenInitiator" value="Hello Jasmine"-->
    <button id="fullscreen-button" onclick="speaktts()"></button><br>
    <div id="terminal" tabindex="0">
        <div id="content">
            <span id="text"></span><span id="cursor"></span>
        </div>
    </div>
    <input type="text" id="hiddenInput" autocomplete="off">
	
	<audio id="printSound" src="./sounds/!sci_fi_computer_text-long.wav" preload="auto"></audio>
    <audio id="typeSound" src="./sounds/keyboard-typing-5997.mp3" preload="auto"></audio>

    <script>
        class Terminal {
            constructor(elementId, apiKey) {
                this.terminal = document.getElementById(elementId);
                this.content = document.getElementById('content');
                this.textSpan = document.getElementById('text');
				this.hiddenInput = document.getElementById('hiddenInput');
                this.text = '';
				this.isPrinting = false;
                this.isTyping = false;
                this.printSound = document.getElementById('printSound');
				this.typeSound = document.getElementById('typeSound');
				this.printSound.loop = true;
				this.typeSound.loop = true; 
                this.typingTimer = null;
                this.typeInterval = null;
				this.speechSynthesis = window.speechSynthesis;
				this.speechUtterance = new SpeechSynthesisUtterance();
                this.apiKey = apiKey;
                this.userInput = '';
				this.printQueue = [];
				this.messageHistory = [
					{role: "system", content: "You are a robot programmed by Jasmine's Uncle named Edwin speaking to a girl named Jasmine who is 8 years old. The time now is 7pm and the date is 26 June 2024." }
                ];

                // this.terminal.addEventListener('keydown', this.handleKeyDown.bind(this));
                // this.terminal.addEventListener('keyup', this.handleKeyUp.bind(this));
                // this.terminal.addEventListener('click', () => this.terminal.focus());
				this.terminal.addEventListener('click', this.focusHiddenInput.bind(this));
                this.hiddenInput.addEventListener('input', this.handleInput.bind(this));
                this.hiddenInput.addEventListener('keydown', this.handleKeyDown.bind(this));
				
				// Focus hidden input on load
                this.focusHiddenInput();
            }

            focusHiddenInput() {
                this.hiddenInput.focus();
            }

            handleInput(event) {
                const newChar = event.target.value;
                this.userInput += newChar;
                this.text += newChar;
                this.textSpan.innerHTML = this.text.replace(/\n/g, '<br>');
                this.scrollToBottom();
                this.startTypeSound();
                this.hiddenInput.value = ''; // Clear the input for the next character
            }



            handleKeyDown(event) {
                if (this.isPrinting) return;

                if (event.key === 'Backspace') {
					event.preventDefault();
					this.startTypeSound();
					this.userInput = this.userInput.slice(0, -1);
                    this.text = this.text.slice(0, -1);
                } else if (event.key === 'Enter') {
					event.preventDefault();
                    // this.queuePrint('\n');
					this.text += '\n';
                    this.startTypeSound();
				    this.sendToAPI(this.userInput);
                    this.userInput = '';
                } 
				//else if (event.key.length === 1) {
				//	this.userInput += event.key;
                //    this.text += event.key;
                //    this.startTypeSound();
                //}
                this.textSpan.innerHTML = this.text.replace(/\n/g, '<br>');
                this.scrollToBottom();
            }

            handleKeyUp() {
                //DO NOTHING AS THIS TIMER this.typingTimer = setTimeout(() => this.stopTypeSound(), 100); WILL STOP THE SOUND
            }

            scrollToBottom() {
                this.terminal.scrollTop = this.terminal.scrollHeight;
            }
			
            startPrintSound() {
				console.log("this.typeInterval=", !this.typeInterval);
                if (!this.isPrinting) {
                    this.playPrintSound();
                }
            }
			
            stopPrintSound() {
                this.printSound.pause();
            }

            startTypeSound() {
				// EVERY TIME A KEY IS PRESSED IT WILL RENEW THE setTimeout TIMER, ALLOWING THE TYPING AUDIO TO CONTINUE
				console.log("this.typingTimer=", this.typingTimer);
				if (this.typingTimer == null) {
					console.log("this.typingTimer=", this.typingTimer);
					this.playTypeSound();
				}
				clearTimeout(this.typingTimer);
                this.typingTimer = setTimeout(() => this.stopTypeSound(), 300);
            }
			
            stopTypeSound() {
				console.log("STOPPING SOUND");
                this.typeSound.currentTime = 0;
				this.typeSound.pause();
				this.typingTimer = null;
            }
			
            playPrintSound() {
                this.printSound.currentTime = 0;
                this.printSound.play();
            }

            playTypeSound() {
                this.typeSound.currentTime = 0;
                this.typeSound.play();
            }
			
            //speak(text) {
            //    this.speechSynthesis.cancel(); // Stop any ongoing speech
            //    this.speechUtterance.text = text;
            //    this.speechSynthesis.speak(this.speechUtterance);
            //}
			
			speak(text) {            
				// Check if the browser supports the Web Speech API
				if ('speechSynthesis' in window) {

					
					// Set the voice properties (optional)
					this.speechUtterance.lang = 'en-US';
					this.speechUtterance.pitch = 1; // Range between 0 and 2
					this.speechUtterance.rate = 1; // Range between 0.1 and 10
					this.speechUtterance.volume = 1; // Range between 0 and 1
					this.speechUtterance.text = text;
					
					// Speak the text
					// window.speechSynthesis.speak(this.speechUtterance);
					this.speechSynthesis.cancel(); // Stop any ongoing speech
					this.speechSynthesis.speak(this.speechUtterance);
				} else {
					alert('Sorry, your browser does not support text-to-speech.');
				}
			}
			
            queuePrint(text, speed = 50) {
                this.printQueue.push({ text, speed });
                if (!this.isPrinting) {
                    this.processQueue();
                }
            }

            async processQueue() {
                while ((this.printQueue.length > 0) && (!this.isPrinting)) {
                    const { text, speed } = this.printQueue.shift();
                    await this.print(text, speed);
                }
            }
			
			async print(text, speed = 50) {
				console.log (text);
				if ((text.replace(/\n/g, '') != "processing...") && (text.replace(/\n/g, '') != "Hello Jasmine...")) {
					console.log ("speaking:",  "'" + text + "'");
					this.speak(text);
					// speak2(text);
				}
				
				this.isPrinting = true;
				this.playPrintSound();
				for (let char of text) {
					this.text += char;
					this.textSpan.innerHTML = this.text.replace(/\n/g, '<br>');
					this.scrollToBottom();
					await new Promise(resolve => setTimeout(resolve, speed));
				}
				this.isPrinting = false;
				this.stopPrintSound();
			}
			
            async sendToAPI(input) {
                this.queuePrint('\nprocessing...\n');
                try {
					// Add user's message to history
                    this.messageHistory.push({role: "user", content: input});
				
                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${this.apiKey}`
                        },
                        body: JSON.stringify({
                            model: "gpt-3.5-turbo",
							messages: this.messageHistory
                            // messages: [{role: "user", content: input}]
							
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    const aiResponse = data.choices[0].message.content;

                    // Add AI's response to history
                    this.messageHistory.push({role: "assistant", content: aiResponse});
					
                    this.queuePrint(aiResponse + '\n\n');
                } catch (error) {
                    console.error('Error:', error);
                    this.queuePrint('\nAn error occurred while communicating with the API.\n\n');
                }
            }
        }
		
		var k4 = "zSRYw0ajk9MMu2ihOn";
		var k1 = "sk-d9nDlXz";
		var k3 = "HJT3BlbkFJVL";
		var k2 = "IQtPapmQysK";


		var OPENAI_API_KEY = k1+k2+k3+k4;
		
		// Initialize the terminal with your API key
        const term = new Terminal('terminal', OPENAI_API_KEY);

        // Example usage
        // term.print("Welcome to the 80s Blue CRT Terminal!\nType your commands below:\n\n");
		
		// initTTS();
		
		// Add the event listener for the window onload event
        // window.addEventListener('load', initTTS());
		
		document.getElementById('fullscreen-button').addEventListener('click', function() {
			this.style.display = 'none';
			// Focus hidden input on load
            term.focusHiddenInput();
		});

        function speak2(text) {
            
            // Check if the browser supports the Web Speech API
            if ('speechSynthesis' in window) {
                // Create a new SpeechSynthesisUtterance object
                const utterance = new SpeechSynthesisUtterance(text);
                
                // Set the voice properties (optional)
                utterance.lang = 'en-US';
                utterance.pitch = 1; // Range between 0 and 2
                utterance.rate = 1; // Range between 0.1 and 10
                utterance.volume = 1; // Range between 0 and 1
                
                // Speak the text
                window.speechSynthesis.speak(utterance);
            } else {
                alert('Sorry, your browser does not support text-to-speech.');
            }
        }
		
        function speaktts() {
            // Get the text input
            const text = "Hello Jasmine 1.9...";
			
			term.print("Hello Jasmine...\n\n");
            
            // Check if the browser supports the Web Speech API
            if ('speechSynthesis' in window) {
                // Create a new SpeechSynthesisUtterance object
                const utterance = new SpeechSynthesisUtterance(text);
                
                // Set the voice properties (optional)
                utterance.lang = 'en-US';
                utterance.pitch = 1; // Range between 0 and 2
                utterance.rate = 1; // Range between 0.1 and 10
                utterance.volume = 1; // Range between 0 and 1
                
                // Speak the text
                window.speechSynthesis.speak(utterance);
            } else {
                alert('Sorry, your browser does not support text-to-speech.');
            }
        }

function adjustDivSize() {
    const adjustableDiv = document.getElementById('terminal');
    // Get the current viewport height and adjust it to 80%
    const viewportHeight = Math.floor(window.innerHeight * 0.8);
    adjustableDiv.style.height = `${viewportHeight}px`;
	term.print("adjusting height to " + viewportHeight + "...\n\n");
}

function adjustDivSizeFocus() {
    const adjustableDiv = document.getElementById('terminal');
    // Get the current viewport height and adjust it to 80%
    const viewportHeight = Math.floor((document.documentElement.clientHeight/2) * 0.8);
    adjustableDiv.style.height = `${viewportHeight}px`;
	term.print("adjusting height to " + viewportHeight + "...\n\n");
	const viewportMarginTop = Math.floor(document.documentElement.clientHeight * 0.1);
	adjustableDiv.style.position = `absolute`;
	adjustableDiv.style.top = `${viewportMarginTop}px`;
}

function adjustDivSizeBlur() {
    const adjustableDiv = document.getElementById('terminal');
    // Get the current viewport height and adjust it to 80%
    const viewportHeight = Math.floor(document.documentElement.clientHeight * 0.8);
    adjustableDiv.style.height = `${viewportHeight}px`;
	term.print("adjusting height to " + viewportHeight + "...\n\n");
	const viewportMarginTop = Math.floor((document.documentElement.clientHeight * 0.1));
	adjustableDiv.style.position = `absolute`;
	adjustableDiv.style.top = `${viewportMarginTop}px`;
}

// Adjust div size on initial load
adjustDivSize();

// Adjust div size when window is resized
window.addEventListener('resize', adjustDivSize);

// Optional: Adjust div size when focus or blur events occur on input elements
document.querySelectorAll('input, textarea').forEach(element => {
    element.addEventListener('focus', adjustDivSizeFocus);
    element.addEventListener('blur', adjustDivSizeBlur);
});
    </script>
</body>
</html>